<h1>1. 의존성이란?</h1>
<ul>
  <li>
    의존성이란 <strong>어떤 시점에 필요한 정보</strong>를 의미하며 대개는 정보가 필요한 시점에 바로 가져오는 코드를 작성한다.
  </li>
    <ul>
      <li>
        웹 프레임워크는 바이트로 전달된 HTTP 요청을 데이터 구조로 변환한다. 이후 우리는 <strong>웹 계층에 있는 함수에서 정보를 추출</strong>한다.
      </li>
    </ul>
</ul>

<br><br>

<h1>2. 의존성 관련 문제</h1>
<ul>
  <li>
    원하는 정보를 얻을 때 <strong>외부 코드</strong>가 어떻게 정보를 처리하는지 알 필요가 없는 것은 합리적이지만 다음과 같은 <strong>대가</strong>가 있다.
  </li>
    <ul>
      <li>
        <strong>테스트</strong>: 의존성을 다른 방식으로 얻을 수 없어, 테스트를 위해 <strong>함수를 변형할 수 없다</strong>.
      </li>
      <li>
        <strong>숨겨진 의존성</strong>: 세부 사항을 숨기면 외부 코드가 변경될 때 우리가 작성한 코드가 망가질 수 있다.
      </li>
      <li>
        <strong>중복 호출</strong>: 데이터베이스에서 사용자를 조회하거나 HTTP 요청 값을 결합하는 등 <strong>의존성이 공통으로 사용</strong>되면 여러 함수에서 중복으로 호출될 수 있다.
      </li>
      <li>
        <strong>OpenAPI 가시성</strong>: FastAPI가 생성하는 자동화된 API 문서는 <strong>의존성 주입 메커니즘에 대한 정보</strong>가 필요하다.
      </li>
    </ul>
</ul>

<br><br>

<h1>3. 의존성 주입</h1>
<ul>
  <li>
    <strong>의존성 주입</strong>이란 필요한 특정 정보를 함수에 전달하는 것으로 <strong>헬퍼 함수(helper function)</strong>를 전달한 뒤, 호출해 특정 데이터를 가져온다.
  </li>
</ul>

<br><br>

<h1>4. FastAPI 의존성</h1>
<ul>
  <li>
    의존성을 함수 인자로 정의하고, <strong>FastAPI가 자동 호출</strong>하여 호출 결과로 반환되는 값을 <strong>인자에 전달</strong>할 수 있다.
  </li>
  <li>
    데이터 유효성 검사, 타입 변환 그리고 자동 문서화를 함수로 직접 작성할 수도 있겠지만 이미 있는 기능을 사용하는 것이 좋다.
  </li>
</ul>

<br><br>

<h1>5. 의존성 작성</h1>
<ul>
  <li>
    의존성은 <strong>FastAPI가 실행</strong>해야 하며 따라서 의존성 객체는 괄호 인자를 사용해 호출할 수 있는 <strong>함수와 클래스를 포함한 Callable 타입</strong>이어야 한다. 
  </li>
</ul>

```python
# 1. 의존성 함수
from fastapi import FastAPI, Depends, Query

app = FastAPI()

# 의존성 함수
#   - FastAPI의 경로 함수처럼 작동하지만 Query와 같은 것들을 사용할 수 있다.
#   - 함수 선언부에 데코레이터가 없기에 웹 엔드포인트가 아닌 헬퍼 함수이다.
def user_dep(name: str = Query(...), gender: str = Query(...)):
    return {"name": name, "valid": True}

# 경로 함수 / 웹 엔드포인트:
#   - user_dep()에서 필요한 user인자를 받아온다.
#   - 사용 시점이 아닌 정의 시점에 user_dep() 함수를 호출하기에 인수 배정이 불가하며
#     필요할 때만 호출하도록 헬퍼 함수인 Depends가 필요하다.
@app.get("/user")
def get_user(user: dict = Depends(user_dep)) -> dict:
    return user
```

<br><br>

<h1>6. 의존성 스코프</h1>
<ul>
  <li>
    의존성은 <strong>하나의 경로 함수</strong>, <strong>경로 함수 그룹</strong> 혹은 <strong>전체 웹 앱</strong>에 정의할 수 있다.
  </li>
</ul>

<br>

<h2>6-1. 경로 스코프</h2>

```python
# 1. 경로 함수에 인자를 포함하는 두 가지 방식

# 첫 번째
def pathfunc(name: depfunc = Depends(depfunc)):

# 두 번째 방식
def pathfunc(name: depfunc = Depends()):
```

```python
# 2. 유저 의존성 반환
from fastapi import FastAPI, Depends, Query

app = FastAPI()

# 의존성 함수
#   - 유저 이름인 name과, 유효한 유저인지 판단하기 위한 valid를 고정값으로 반환.
def user_dep(name: str, Query(...), gender: str = Query(...)):
    return {"name": name, "valid": True}

# 경로 함수 / 웹 엔드포인트
@app.get("/user")
def get_user(user: dict = Depends(user_dep)) -> dict:
    return user
```

```python
# 3. 유저를 검사하는 의존성 정의
#   - 이번에는 경로 함수에 의존성을 정의한다.
from fastapi import FastAPI, Depends, Query

app = FastAPI()

# 의존성 함수:
def check_dep(name: str= Query(...), gender: str = Query(...)):
    if not name:
        raise

# 경로 함수 / 웹 엔드포인트
#   - 경로 함수 내에 의존성 정의
@app.get("/check_user", dependencies=[Depends(check_dep)])
def check_user() -> bool:
    return True
```

<br>

<h2>6-2. 다중 경로 스코프</h2>
<ul>
  <li>
    최상위 앱 하위에 둘 이상의 라우터 객체를 정의해 더 큰 규모의 FastAPI 앱을 구성할 수도 있다. (자세한 건 9장).
  </li>
</ul>

```python
# 1. 하위 라우터 의존성 정의
from fastapi import FastAPI, Depends, APIRouter

router = APIRouter(..., dependencies=[Depends(depfunc)])
```

<br>

<h2>6-3. 전역 스코프</h2>

```python
# 1. 앱 수준의 의존성 정의
from fastapi import FastAPI, Depends

def depfunc1():
    pass

def depfunc2():
    pass

app = FastAPI(dependencies=[Depends(depfunc1), Depends(depfunc2)])

@app.get("/main")
def get_main():
    pass
```