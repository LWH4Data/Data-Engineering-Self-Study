<h1>1. Multipart 지원</h1>
<ul>
  <li>
    대용량 파이릉ㄹ 처리하기 위해 FastAPI의 업로드 및 다운로드 기능에 아래의 모듈을 추가한다.
  </li>
    <ul>
      <li>
        Python-Multipart
      </li>
      <li>
        aio-files
      </li>
    </ul>
</ul>

<br><br>

<h1>2. 파일 업로드</h1>
<ul>
  <li>
    FastAPI는 API 개발에 초점이 맞춰져 있지만 파일 업로드에 <strong>File()</strong>과 <strong>uploadFile</strong> 두 가지 옵션을 제공한다.
  </li>
</ul>

<br>

<h2>2-1. File()</h2>
<ul>
  <li>
    File()은 <strong>직접 파일 업로드</strong>에 사용되며 비동기 버전이 더 좋다.
  </li>
  <li>
    FastAPI는 파일을 청크로 가져와 <strong>메모리에서 재조립</strong>하기에 <strong>비교적 작은 파일</strong>에만 File()을 사용해야 한다.
  </li>
  <li>
    입력이 JSON이라고 가정하는 대신 파일을 양식의 인자로 인코딩한다.
  </li>
</ul>

```python
# 1. FastAPI로 작은 파일 업로드 처리하기.
from fastAPI import File

@app.post("/small")
async def upload_small_file(small_file: bytes = File()) -> str:
    return f"file size: {len(small_file)}"
```

<br>

<h2>2-2. UploadFile</h2>
<ul>
  <li>
    대용량의 파일의 경우 UploadFile을 사용하는 것이 좋다.
  </li>
    <ul>
      <li>
        주로 메모리가 아닌 <strong>서버의 디스크</strong>에 SpooledTemporaryFile 이라는 파이썬 객체를 생성한다.
      </li>
    </ul>
  <li>
    파일과 유사한 객체로 <strong>read()</strong>, <strong>write()</strong>, <strong>seek()</strong> 메서드를 지원하며 파일 조각이 업로드 되는 동안 웹 서버가 멈추지 않도록 def 대신 <strong>async def</strong>를 사용한다.
  </li>
  <li>
    File()은 bytes 객체를 생성하기에 괄호가 필요한 반면 UploadFile은 다른 클래스의 객체이다.
  </li>
</ul>

```python
# 1. FastAPI로 대용량 파일 업로드
from fastapi import UploadFile

@app.post("/big")
async def upload_big_file(big_file: UploadFile) -> str:
    return f"file size: {big_file.size}, name: {big_file.filename}"
```

<br><br>

<h1>3. 파일 다운로드</h1>
<h2>3-1. FileResponse</h2>
<ul>
  <li>
    한 번에 한 곳에서 처리한다.
  </li>
</ul>

```python
# 1. FileResponse를 사용해 작은 파일을 다운로드.
from fastapi.responses import FileResponse

@app.get("/small/{name}")
async def download_small_file(name):
    return FileResponse(name)
```

<br>

<h2>3-2. StreamingResponse</h2>
<ul>
  <li>
    <strong>대용량 파일</strong>을 다운로드할 때에는 파일을 <strong>청크 단위로 변환</strong>하는 <strong>StreamingResponse</strong>를 사용하는 것이 좋다.
  </li>
  <li>
    파일 경로가 존재하지 않으면 open() 호출이 예외를 발생시킨다.
  </li>
</ul>

```python
# 1. StreamingResponse로 큰 파일 변환.
from typing import Generator
from fastapi.responses import StreamingResponse

def gen_file(path: str) -> Generator:
    with open(file=path, mode="rb") as file:
        yield file.read()

@app.get("/download_big/{name}")
async def download_big_file(name:str):
    gen_expr = gen_file(path=name)
    response = StreamingResponse(
        content=gen_expr,
        status_code=200,
    )
    return response
```

<br><br>

<h1>4. 정적 파일 서비스</h1>
<ul>
  <li>
    기존 웹 서버는 서버 파일을 일반 파일시스템에 있는 것처럼 취급할 수 있는데 FastAPI의 <strong>StaticFiles</strong>로 작업을 수행할 수 있다.
  </li>
</ul>

```python
# 1. StaticFiles를 사용해 디렉터리의 모든 것을 제공.
from pathlib import Path
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles

# main.py가 포함된 디렉터리:
top = Path(__file__).resolve().parent

app.mount("/static",
    StaticFiles(directory=f"{top}/static", html=True),
    name="free")
```