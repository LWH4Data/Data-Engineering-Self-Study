<h1>1. 딥러닝이란</h1>
<ul>
  <li>
    <strong>신경망</strong>이란 <strong>가중치(weight)</strong>와 <strong>활성화 함수(activation function)</strong>를 가진 노드로 구성된 <strong>그래프</strong>이다.
  </li>
  <li>
    노드는 하나씩 위로 쌓아올려져서 하나의 <strong>계층(layer)</strong>으로 구성된다.
  </li>
  <li>
    네트워크상에서 각 계층은 부분적 혹은 완전히 <strong>이전 계층과 연결</strong>된다.
  </li>
  <li>
    간단하게 계층이 하나씩 추가될수록 더 복잡한 입력 신호를 잘 인식할 수 있다.
  </li>
  <li>
    딥러닝 학습의 최종 목표는 네트워크상 <strong>각 노드 사이의 연결</strong>과 그에 대한 <strong>가중치</strong> 및 <strong>각 노드의 값</strong>을 적절히 조정하여 어떤 값이 입력 되었을 때 특정한 출력값과 연관시킬 수 있도록 <strong>네트워크를 학습</strong>시키는 것이다.
  </li>
  <li>
    딥러닝 또는 심층 신경망(Deep Neural Network, DNN)은 다양한 아키텍처를 형성하며 이러한 계층을 무수히 쌓아올린다.
  </li>
  <li>
    Spark는 <strong>빅데이터</strong>와 <strong>병렬 컴퓨팅 시스템</strong>으로서의 강점을 갖고 있기 때문에 딥러닝을 사용하기에 적합한 프레임워크이다.
  </li>
</ul>

<br><br>

<h1>2. 스파크에서 딥러닝을 사용하는 방법</h1>
<h2>2-1. 추론</h2>
<ul>
  <li>
    딥러닝을 사용하는 가장 간단한 방법은 <strong>이미 학습된 모델</strong>을 Spark로 가져와서 대용량 데이터셋에 <strong>병렬로 작용</strong>하는 것이다.
  </li>
  <li>
    pyspark를 사용하면 <strong>맵 함수</strong>를 사용해 <strong>텐서플로</strong>나 <strong>파이토치</strong>와 같은 프레임워크를 호출하여 분산 처리를 통한 추론을 할 수 있다.
  </li>
</ul>

<br>

<h2>2-2. 특징 생성과 전이 학습</h2>
<ul>
  <li>
    기존 모델을 결과를 도출하는 용도가 아닌 <strong>특징을 생성</strong>하는 용도로 사용한다.  
  </li>
  <li>
    대부분의 딥러닝 모델은 하위 계층에서의 학습을 통해 유용한 <strong>특징 표현 학습(feature representation learning)</strong>을 한다.
  </li>
  <li>
    특징 표현 학습을 완료한 결과를 새로운 모델을 학습하는 데 활용하는 <strong>전이 학습(transfer learning)</strong>을 수행할 수 있다.
  </li>
    <ul>
      <li>
        전이 학습과 모델의 마지막 몇 개의 계층만 다른 데이터셋을 대상으로 학습시킨다.
      </li>
      <li>
        전이 학습은 본래 분석하고자 하는 <strong>학습 데이터가 충분하지 않은 경우</strong> 사용하면 유용하다.
      </li>
      <li>
        이미 학습된 부분을 사용하기에 과적합의 위험 또한 적다.
      </li>
    </ul>
</ul>

<br>

<h2>2-3. 모델 학습</h2>
<ul>
  <li>
    Spark는 신규 딥러닝 모델을 학습할 때에도 <strong>두 가지 방법</strong>을 제공한다.
  </li>
    <ul>
      <li>
        하나의 Spark 클러스터를 사용하여 <strong>단일 모델</strong>에 대한 학습을 <strong>여러 서버에서 병렬 처리</strong>하고 각 서버 간의 통신을 통해 최종 결과를 업데이트 한다.
      </li>
      <li>
        특정 라이브러리를 사용해 <strong>다양한 모델 객체</strong>를 <strong>병렬로 학습</strong>시키고 다양한 모델 아키텍처와 하이퍼파리미터를 검토하여 최종 모델 선택과 최적화 과정을 수행한다.
      </li>
    </ul>
  <li>
    Spark는 학습 뿐만아니라 <strong>ETL 단계</strong>까지 수행할 수 있기에 단일 병렬 워크플로로 결합하기 용이하다는 장점 또한 갖는다.
  </li>
</ul>

<br><br>

<h1>3. 딥러닝 라이브러리</h1>
<h2>3-1. MLlib에서 지원하는 신경망</h2>
<ul>
  <li>
    Spark의 MLlib은 현재 기본적으로 <strong>ml.classification.MultilayerPerceptronClassifier 클래스</strong>의 다층 퍼셉트론 분류기(multilayer perceptron classifier)와 같은 <strong>단일 심층 학습(single deep learning)알고리즘</strong>을 지원한다.
  </li>
  <li>
    해당 클래스는 시그모이드 활성화 함수를 사용하는 <strong>완전 연결 계층(fully connected layer)</strong>과 소프트맥스 활성화 함수를 사용하는 <strong>출력 계층</strong>을 포함하며 상대적으로 <strong>얕은 네트워크(shallow network)</strong>를 학습하도록 제한된다.
  </li>
    <ul>
      <li>
        이는 전이 학습을 하여 분류 모델의 <strong>마지막 몇 개의 계층</strong>을 학습하는 데 가장 유용하다.
      </li>
    </ul>
</ul>

<br>

<h2>3-2. 텐서프레임</h2>
<ul>
  <li>
    텐서프레임(TensorFrames)은 <strong>Spark DataFrame과 텐서플로</strong> 간에 데이터 송수신을 쉽게 하도록 도와주는 <strong>추론 및 전이 학습 지향 라이브러리</strong>이다.
  </li>
  <li>
    텐서프레임을 사용하여 Spark DataFrame에 모델을 적용하면 <strong>빠른 데이터 전송 및 초기 구동 비용</strong>에 대한 비용 상쇄 효과로 인해 텐서플로 모델을 직접 불러오는 파이썬 맵 함수를 호출하는 것보다 일반적으로 더 효율적이다.
  </li>
  <li>
    전이 학습 시에는 기존 모델을 원시 데이터에 적용하여 <strong>특징을 추출</strong>한 다음 MultilayerPerceptronClassifier 또는 더 단순한 로직스틱 회귄나 랜덤 포레트스 분류기를 사용하여 <strong>마지막 계층을 학습</strong>시킬 수 있다.
  </li>
</ul>

<br>

<h2>3-3. BigDL</h2>
<ul>
  <li>
    <strong>BigDL</strong>은 인텔에서 개발한 Spark의 분산 딥러닝 프레임워크로 <strong>추론</strong>을 사용하여 딥러닝 모델의 빠른 적용과 대용량 모델의 <strong>분산 학습(distributional training)</strong>을 지원한다.
  </li>
  <li>
    GPU가 아니라 <strong>CPU 활용</strong>에 최적화되어 있다. 따라서 Hadoop과 같은 CPU 기반 클러스터에도 구현이 가능하다.
  </li>
  <li>
    <strong>신규로 신경망을 구축</strong>할 수 있는 고급 API를 제공하며 기본적으로 모든 작업을 <strong>자동으로 분산</strong> 처리한다.
  </li>
  <li>
    Keras DL 라이브러리로 작성된 모델도 학습할 수 있다.
  </li>
</ul>

<br>

<h2>3-4. TensorFlowOnSpark</h2>
<ul>
  <li>
    TensorFlowOnSpark는 Spark 클러스터에서 <strong>텐서플로 모델을 병렬로 학습</strong>시키는 데 사용하는 대중적인 라이브러리이다.
  </li>
  <li>
    텐서플로에는 분산 학습을 수행하는 데 필요한 기본적인 기술이 포함되어 있지만, <strong>하드웨어 및 데이터 통신</strong>을 관리는 <strong>클러스터 매니저에 의존</strong>해야 한다.
  </li>
    <ul>
      <li>
        TensorFlowOnSpark를 사용하여 <strong>Spark 클러스터</strong> 내에서 잡을 쉽게 시작할 수 있고, Spark가 지원하는 모든 입력 소스로부터 가져온 <strong>데이터를 클러스터에 전달</strong>할 수 있다.
      </li>
      <li>
        데이터에는 DataFrame 변환과 같은 <strong>다른 Spark 라이브러리</strong>로 처리한 데이터도 포함된다.
      </li>
    </ul>
</ul>

<br>

<h2>3-5. DeepLearning4J</h2>
<ul>
  <li>
    <strong>단일 노드</strong> 및 <strong>분산 학습 옵션</strong>을 모두 제공하는 Java 및 Scala의 오픈소스이자 분산 딥러닝 프로젝트이다.
  </li>
  <li>
    JVM용으로 설계되었기에 파이썬 프로세스를 개발 프로세스에 추가하지 않는 경우 유용하다.
  </li>
</ul>

<br>

<h2>3-6. 딥러닝 파이프라인</h2>
<ul>
  <li>
    딥러닝 기능을 <strong>Spark ML 파이프라인 API</strong>에 통합시킨 데이터브릭스의 오픈소스 패키지이다.
  </li>
  <li>
    기존의 딥러닝 프레임워크를 포함하며 두 가지 목표에 중점을 둔다.
  </li>
    <ul>
      <li>
        딥러닝 프레임워크를 <strong>표준 Spark API에 통합</strong>하여 사용하기 쉽게 만든다.
      </li>
      <li>
        모든 연산을 기본적으로 <strong>분산 처리</strong>한다.
      </li>
    </ul>
</ul>

<br><br>

<h1>4. 딥러닝 파이프라인을 사용한 간단한 예제</h1>
<ul>
  <li>
    Spark DataFrame에서 <strong>이미지 처리</strong> 기능.
  </li>
  <li>
    개인이 개발한 모델이건 프레임워크에서 제공하는 표준 모델이건 상관없이 대규모 딥러닝 모델을 <strong>이미지나 텐서 데이텅 적용</strong> 가능.
  </li>
  <li>
    사전학습된 딥러닝 모델을 사용하여 <strong>전이 학습</strong> 가능.
  </li>
  <li>
    모델을 <strong>Spark SQL 함수</strong>로 내보내 <strong>모든 사용자</strong>가 딥러닝을 쉽게 이용 가능.
  </li>
  <li>
    ML 파이프라인을 통해 <strong>분산 딥러닝 하이퍼파라미터 튜닝</strong> 가능.
  </li>
</ul>

<br>

<h2>4-1. 설정하기</h2>
<ul>
  <li>
    딥러닝 파이프라인은 GraphFrame을 로드 했던 방식과 동일하게 진행하면 된다.
  </li>
</ul>

<br>

<h2>4-2. 이미지와 DataFrame</h2>

```python
# 1. 딥러닝 파이프라인을 사용하면 분산 처리 방식으로 이미지에 대한 로드와 디코딩을 쉽게 해주
#    는 유틸리티 함수가 포함되어 있다.
from pyspark.ml.image import ImageSchema

img_dir = "/workspace/Spark-The-Definitive-Guide/data/deel-learning-images/"
image_df = ImageSchema.readimages(sample_img_dir)
```

<br>

<h2>4-3. 전이 학습</h2>

```python
# 1. 유형별 꽃에 대한 데이터를 업로드하고 학습셋과 테스트셋을 생성한다.
from pyspark.ml.image import ImageSchema
from pyspark.sql.functions import lit
from sparkdl.image import imageIO

tulips_df = ImageSchema.readImages(img_dir + "/tulips")
    .withColumn("label", lit(1))
daisy_df = imageIO.readImagesWithCustomFn(img_dir + "/daisy", decode_f=imageIO.PIL_decode)\
    .withColumn("label", lit(0))
tulips_train, tulips_test = tulips_df.randomSplit([0.6, 0.4])
daisy_train, daisy_test = daisy_df.randomSplit([0.6, 0.4])
train_df = tulips_train.unionAll(daisy_train)
test_df = tulips_test.unionAll(daisy_test)
```

```python
# 2. DeepImageFeatureizer 변환자를 통해 전이 학습을 진행.
from pyspark.ml.classification import LogisticRegression
from pyspark.ml import Pipeline
from sparkdl import DeepImageFeaturizer

featurizer = DeepImageFeatureizer(inputCol="image", outputCol="feature", modelName="InceptionV3")
lr = LogisticRegression(maxIter=1, regParam=0.05, elasticNetParam=0.3, labelCol="label")
p = Pipeline(stages=[featurizer, lr])
p_model = p.fit(train_df)
```

```python
# 3. 평가 지표 설정 후 평가.
from pyspark.ml.evaluation import MulticlassClassificationEvaluator

tested_df = p_model.transform(test_df)
evaluator = MulticlassClassificationEvaluator(metricName="accuracy")
print("Test set accuracy = " + str(evaluator.evaluate(tested_df.select("prediction", "label"))))
```

```python
# 4. 예제의 DataFrame의 활용하여 이전 학습에서 예측이 잘목된 row와 이미지 검사.
from pyspark.sql.types import DoubleType
from pyspark.sql.functions import expr

def _p1(v):
    return float(v.array[1])
p1 = udf(_p1, DoubleType())
df = tested_df.withColumn("p_1", p1(tested_df.probability))
wrong_df = df.orderBy(expr("abs(p_1 - label)"), ascending=False)
wrong_df.select("image.origin", "p_1", "label").limit(10)
```

<h3>4-3-1. 대규모 데이터에 딥러닝 모델 적용하기</h3>
<ul>
  <li>
    텐서프레임 라이브러리가 지원되는 변환자는 Spark에 모델 및 데이터 배포를 효율적으로 처리한다.
  </li>
</ul>

<br><br>

<h2>4-4. 인기 있는 표준 모델 사용하기</h2>
<ul>
  <li>
    딥러닝 파이프라인은 케라스에 포함된 다양한 표준 모델을 지원하며 단순히 참조만 하면된다.
  </li>
</ul>

```python
# 1. DeepImagePredictor를 침조하여 사용.
from pyspark.ml.image import ImageSchema
from sparkdl import DeepImagePredictor

image_df = ImageSchema.readImages(img_dir)
predictor = DeepImagePredictor(
    inputCol="image",
    outputCol="predicted_labels",
    modelName="InceptionV3",
    decodePredictions=True,
    topK=10
)
predictions_df = predictor.transform(image_df)
```

```python
# 2. 전이 학습 예제는 기본 모델을 기반으로 데이지와 튤립의 차이점을 적절히 학습했다.
df = p_model.transform(image_df)
df.select("image.origin", (1-p1(df.probability)).alias("p_daisy")).show()
```

<h3>4-4-1. 사용자 정의 케라스 모델 적용하기</h3>
<ul>
  <li>
    딥러닝 파이프라인은 Spark를 사용하여 분산 처리 방식으로 케라스 모델을 적용하도록 지원한다.
  </li>
</ul>

<h3>4-4-2. 텐서플로 모델 사용하기</h3>
<ul>
  <li>
    딥러닝 파이프라인은 텐서플로와의 통합을 통해 텐서플로 기반 이미지를 조작하는 사용자 정의 변환자를 만드는 데 사용할 수 있다.
  </li>
</ul>

<h3>4-4-3. SQL 함수를 사용하여 모델 전개하기</h3>
<ul>
  <li>
    모델을 <strong>SQL 함수로 전개</strong>하여 SQL을 아는 모든 사용자가 딥러닝 모델을 사용할 수 있도록 할 수 있다.
  </li>
  <li>
    모델은 <strong>새로운 컬럼을 생성</strong>하여 해당 모델의 결과를 출력한다.
  </li>
</ul>

```python
# 1. registerKeraImageUDF 클래스를 사용하여 인셉션 v3 모델을 다양한 이미지에 적용.
from keras.applications import InceptionV3
from sparkdl.udf.keras_image_model import registerKerasImageUDF
from keras.applications import InceptionV3

registerKerasImageUDF("my_keras_inception_udf", InceptionV3(weights="imagenet"))
```