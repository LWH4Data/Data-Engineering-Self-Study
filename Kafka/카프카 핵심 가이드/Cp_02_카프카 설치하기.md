<ul>
  <li>
    이번 장은 Kafka 환경 설정에 대해서 다루기에 대부분의 내용은 생략하고 <strong>설정과 관련</strong>된 내용만 기록한다.
  </li>
</ul>

<h1>1. 환경 설정</h1>
<h2>1-1. 운영체제 선택하기</h2>
<ul>
  <li>
    OS에 적합한 환경을 선택하여 진행한다.
  </li>
</ul>

<br>

<h2>1-2. 자바 설치하기</h2>
<ul>
  <li>
    Ubuntu를 활용하여 linux 환경에서 경로를 생성하고 도서에서 지정된 버전의 JDK를 다운 받는다.
  </li>
  <li>
    linux 환경을 사용하기에 권한 설정이 필요하다.
  </li>
  <li>
    도서의 경우 /usr/java/jdk-11.0.10에 다운 받고, JAVA_HOME 경로를 변경하는 방법을 활용하는데 <strong>기본적으로 세팅되어 있는 경로(/usr/lib/java)</strong>에 JDK를 다운 받아서 활용해도 무관하다.
  </li>
</ul>

<br>

<h2>1-3. 주키퍼 설치하기</h2>
<h3>1-3-1. 독립 실행 서버</h3>

```bash
# 다운 받은 Kafka의 압축을 해제한다.
tar -zxf apache-zookeeper-3.5.9-bin.tar.gz

# 압축 해제한 폴더명을 'apache-zookeeper-3.5.9-bin → zookeeper'로 수정한다.
mv apache-zookeeper-3.5.9-bin /usr/local/zookeeper

# 필요한 폴더 생성
mkdir -p /var/lib/zookeeper

# zookeeper 설정 설정. (도서는 cat을 사용하는데 권한 문제로 tee를 사용해야할 수도 있다).
cat > /usr/local/zookeeper/conf/zoo.cfg << EOF
tickTime=2000
dataDir=/var/lib/zookeeper
clientPort=2181
EOF

# 기본 자파 경로를 설정하는 것인데 원래 환경을 사용할 것이라면 진행하지 않도록 한다.
export JAVA_HOME=/usr/java/jdk-11.0.19

# 주키퍼를 실행한다.
/usr/local/zookeeper/bin/zkServer.sh start

# 주키퍼의 정보를 조회한다. (telnet이 없다면 다운받기).
# 주키퍼의 포트인 2181로 확인한다.
telnet localhost 2181
```

<h3>1-3-2. 주키퍼 앙상블</h3>
<ul>
  <li>
    zookeeper는 고가용성을 보장하기 위해 <strong>앙상블(ensemble)</strong>이라 불리는 <strong>클러스터 단위</strong>로 작동하도록 설계되었다.
  </li>
    <ul>
      <li>
        zookeeper가 사용하는 부하 분산 알고리즘 때문에 앙상블은 <strong>홀수 개의 서버</strong>를 가지는 것이 권장된다.
      </li>
        <ul>
          <li>
            zookeeper가 요청에 응답하려면 앙상블 멤버(quorum)의 <strong>과반 이상이 작동</strong>하고 있어야하기 때문이다.
          </li>
        </ul>
      <li>
        zookeeper 앙상블을 구성할 때에는 <strong>5개</strong>의 노드 크기를 고려한다.
      </li>
        <ul>
          <li>
            <strong>정비 작업</strong>을 수행할 시에 2대 이상의 노드 정지를 받아낼 수 있어야 한다.
          </li>
          <li>
            9대 이상의 노드는 <strong>합의(consensus) 프로토콜</strong> 특성상 성능이 나빠진다.
          </li>
          <li>
            클라이언트가 너무 많아 5대 혹은 7대의 노드가 부하를 감당하기 힘들다면 <strong>옵저버 노드</strong>를 추가하여 읽기 전용 트래픽을 분산 시킬 수 있다.
          </li>
        </ul>
    </ul>
  <li>
    주키퍼 서버를 앙상블로 구성하기 위해서는 다음 두 가지가 필요하다.
  </li>
    <ul>
      <li>
        각 서버는 <strong>공통된 설정 파일</strong>을 사용해야 한다.
      </li>
        <ul>
          <li>
            설정 파일에는 앙상블에 포함된 모든 서버의 목록이 포함되어야 한다.
          </li>
          <li>
            각 서버는 데이터 디렉토리에 자신의 ID 번호를 지정하는 myid 파일을 가지고 있어야 한다.
          </li>
          <li>
            설정에서 initLimit 값은 팔로워가 리더와의 연결할 수 있는 초기화 제한 시간을, syncLimit은 팔로워와 리더가 연결할 수 있는 동기화 제한 시간을 의미한다.
          </li>
            <ul>
              <li>
                위 두 값은 모두 tickTime 단위로 정의된다.
              </li>
            </ul>
          <li>
            설정은 앙상블 안의 모든 서버 내역 <strong>{X}={hostname}:{peerPort}:{leaderPort}</strong> 또한 정의한다. 
          </li>
            <ul>
              <li>
                <strong>X</strong>: 서버의 ID. 정숫값이어야 하지만 0부터 시작할 필요가 없고, 순차적일 필요도 없다.
              </li>
              <li>
                <strong>hostname</strong>: 서버의 호스트명 또는 IP 주소
              </li>
              <li>
                <strong>peerPort</strong>: 앙상블 안의 <strong>서버들이 서로 통신</strong>할 때 사용하는 TCP 포트 번호
              </li>
              <li>
                <strong>leaderPort</strong>: <strong>리더를 선출</strong>하는 데 사용되는 TCP 포트 번호
              </li>
            </ul>
          <li>
            클라이언트는 clientPort에 지정된 포트 번호로 앙상블에 연결할 수 있으면 되지만, 앙상블의 멤버들은 <strong>세 포트를 모두</strong> 사용해서 서로 통신할 수 있어야 한다.
          </li>
        </ul>
      <li>
        공통 설정 파일 외에도 각 서버는 dataDir 디렉토리에 <strong>myid</strong>라는 이름의 파일을 가지고 있어야 한다.
      </li>
        <ul>
          <li>
            파일은 설정 파일에 지정된 것과 일치하는 서버 ID 번호를 포함해야 한다.
          </li>
        </ul>
    </ul>
</ul>

<h4>한 대의 서버에서 주키퍼 앙상블 테스트하기</h4>
<ul>
  <li>
    설정 파일의 모든 호스트명을 <strong>localhost</strong>로 지정하고 모든 peerPort, leaderPort에 <strong>서로 다른 포트</strong>를 할당하여 하나의 서버에서 주키퍼 앙상블을 실행하고 테스트할 수 있다.
  </li>
  <li>
    각각의 주키퍼 인스턴스에 서로 다른 dataDir와 clientPort를 할당하기 위해서 <strong>추가적인 zoo.cfg</strong>를 생성해야 할 수도 있다.
  </li>
  <li>
    테스트 방법은 테스트 환경에서는 유용하겠으나, 프로덕션 시스템에는 권장하지 않는다.
  </li>
</ul>

<br><br>

<h1>2. 카프카 프로커 설치하기</h1>
<ul>
  <li>
    자바와 주키퍼가 설정되어 있다면 이제 Kafka를 설치할 준비가 된 것이다. (https://kafka.apache.org/downloads.html, 교재는 2.7.0 사용).
  </li>
  <li>
    구버전에서 사용하던 <strong>--zookeeper</strong> 연결 문자열은 거의 모든 경우 지원이 중단 되었으며, 대체재는 <strong>--bootstrap-server</strong>를 사용해서 kafka 브로커에 직접 연결하는 방법이 있다.
  </li>
</ul>

```bash
# 생성한 /usr/local/로 이동후 
sudo wget https://archive.apache.org/dist/kafka/2.7.0/kafka_2.12-2.7.0.tgz

# 받은 Kafka 파일 압축 해제
sudo tar -zxf kafka_2.13-2.7.0.tgz

# 해제한 파일명을 'kafka_2.12-2.7.0.tgz → /usr/local/kafka'로 변경
sudo mv kafka_2.12-2.7.0 /usr/local/kafka

# kafka로그를 저장할 파일 생성.
sudo mkdir /tmp/kafka-logs

# 자바 기본 경로 변경. (기본 환경을 사용한다면 설정 X).
sudo export JAVA_HOME=/usr/java/jdk-11.0.10

# kafka 실행.
sudo /usr/local/kafka/bin/kafka-server-start.sh -daemon \
    /usr/local/kafka/config/server.properties

# topic을 생성하여 kafka가 실행 중인지 테스트
/usr/local/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 \
    --create --replication-factor 1 --partitions 1 --topic test

# 생성한 topic에 대한 정보 확인
/usr/local/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 \
    --describe --topic test

# topic에 메시지 쓰기
/usr/local/kafka/bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic test
Test Message 1
Test Message 2
# Ctrl + C를 눌러 종료

# 쓴 메시지 읽기
/usr/local/kafka/bin/kafka-console-consuer.sh --bootstrap-server localhost:9092 --topic test --from-beginning
# Ctrl + C를 눌러 종료
```

<br><br>

<h1>3. 브로커 설정하기</h1>
<ul>
  <li>
    Kafka의 배포판 설정은 개념 증명(Proof of Concept, PoC)를 목적으로 잘 구성되어 있다.
  </li>
  <li>
    규모가 커질 경우 튜닝을 해야할 수도 있지만, 일반적인 경우는 바꿀 일이 없기에 기본값을 사용해도 된다.
  </li>
</ul>

<br>

<h2>3-1. 브로커 설정하기</h2>
<ul>
  <li>
    단일 서버에서 단독으로 실행되는 브로커가 아니라면 다음의 매개변수들을 설정해 주어야 한다.
  </li>
</ul>

<h3>3-1-1. broker.id</h3>
<ul>
  <li>
    모든 Kafka 브로커는 <strong>정숫값 식별자</strong>를 가지며 <strong>broker.id</strong>로 설정할 수 있다.
  </li>
  <li>
    기본값은 0이며 클러스터 내의 다른 브로커들과는 달라야 한다.
  </li>
  <li>
    Broker id는 <strong>임의로 선택</strong>이 가능하고 필요하다면 Broker간 데이터와 역할 이동도 가능하지만, Broker id는 <strong>호스트별로 고정된 값</strong>을 사용하는 것이 강력하게 권장된다.
  </li>
    <ul>
      <li>
        host1.example.com → broker.id = 1, host2.example.com → broker.id = 2와 같이 호스트 도메인의 숫자와 borker.id의 숫자를 맞추어 준다.
      </li>
    </ul>
</ul>

<h3>3-1-2. listeners</h3>
<ul>
  <li>
    기존에 port를 사용하는 방법은 중단되었다. 대신 <strong>9092 TCP 포트</strong>에서 돌아가는 <strong>listener</strong>와 함께 Kafka를 실행시킨다.
  </li>
  <li>
    listeners 설정은 쉼표로 구분된 <strong>리스터 이름</strong>과 <strong>URI 목록</strong>이다.
  </li>
    <ul>
      <li>
        일반적인 보안 프로토콜이 아닌 경우 반드시 listeners.security.protocol.map 설정을 잡아주어야 한다.
      </li>
      <li>
        Listener는 <strong>{프로토콜}://{호스트 이름}:{포트}</strong>의 형태로 정의된다.
      </li>
        <ul>
          <li>
            PLAINTEXT://localhost:9092
          </li>
            <ul>
              <li>
                localhost의 9092로 들어오는 데이터(메시지, 메타데이터 등)를 PLAINTEXT로 듣고 있음.
              </li>
            </ul>
          <li>
            SSL://:9091
          </li>
            <ul>
              <li>
                모든 인터페이스(0.0.0.0 → :로 생략됨)에서 들어오는 정보를 SSL로 암호화하여 듣고 있음.
              </li>
            </ul>
        </ul>
      <li>
        호스트 이름을 <strong>0.0.0.0(생략되기도 함)</strong>으로 잡을 경우 <strong>모든 네트워크 인터페이스</strong>로부터 연결을 받게 된다.
      </li>
    </ul>
  <li>
    listeners 설정을 하지 않는 경우 <strong>기본 인터페이스</strong>에 대해서만 연결을 받는다.
  </li>
  <li>
    <strong>1024 미만의 포트</strong>를 사용하는 것은 권장하지 않으며, 만약 사용한다 하더라도 루트 권한으로 Kafka를 실행시켜야 한다.
  </li>
</ul>

<h3>3-1-3. zookeeper.connect</h3>
<ul>
  <li>
    
  </li>
</ul>